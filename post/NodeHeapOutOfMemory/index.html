<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="NEW NUY">





<title>建置 Angular 時發生 Heap out of memory | NEWNUY&#39;s Reflection</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162520708-1"></script>
    <script>
        var host = window.location.hostname;
        // Avoid 'localhost' to be tracked
        if (host !== "localhost") {
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-162520708-1');
        }
    </script>


<!-- Google AdSense script -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7455155284654484"
crossorigin="anonymous"></script>

<meta name="generator" content="Hexo 4.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Memento mori</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about/">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Memento mori</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about/">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">建置 Angular 時發生 Heap out of memory</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: September 19, 2020
                    
                    
                        </span>
                    
                        <div>
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Web/">Web</a>
                            
                        </span>
                        </div>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前陣子在處理 Jenkins 的 Automation，在 build Angular 專案時發生了 Heap out of memory 的問題，稍微看了下要怎麼解決，還有發生的原因可能是什麼</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory</span><br></pre></td></tr></tbody></table></figure>

<h2 id="簡單的解決方式"><a href="#簡單的解決方式" class="headerlink" title="簡單的解決方式"></a>簡單的解決方式</h2><p>簡單的方法就是在執行 <code>ng build</code> 時增加 default build heap size </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --max-old-space-size=&lt;size-you-want&gt; node_modules/@angular/cli/bin/ng build &lt;your-app-module&gt; --prod</span><br></pre></td></tr></tbody></table></figure>

<p>要注意的是 <code>@angular/cli/bin/ng</code> 的路徑是不是你目前要 build 的 app 使用的，有可能在外層，看你環境的設定</p>
<p>可以把這段加到 package.json 的 scripts 方便執行</p>
<h2 id="可能的原因"><a href="#可能的原因" class="headerlink" title="可能的原因"></a>可能的原因</h2><h3 id="RAM"><a href="#RAM" class="headerlink" title="RAM"></a>RAM</h3><p>最直觀的原因就是機器的 memory 不夠使用</p>
<p>這個 issue 是在 Windows VM 上跑多個 Jenkins Job 發生的，在多數 local build 的情況並沒有遇過，甚至在跑更多 Job 的 Linux server 也沒碰過</p>
<p>後來去看了下該機器的 RAM，原來只有 4GB…?</p>
<p>現在大部分人的筆電至少都配有 8GB，桌電的話更是 16 GB 起跳，所以團隊幾乎沒人遇過 out of memory 的 build error</p>
<h3 id="V8-Engine-限制"><a href="#V8-Engine-限制" class="headerlink" title="V8 Engine 限制"></a>V8 Engine 限制</h3><p>再來可能的就是專案在開發時 Module 越來越肥大，需要 Build 的 js 佔用太多動態記憶體，而 NodeJS builder 是採用 <a href="https://g.co/kgs/yR57fL" target="_blank" rel="noopener">V8 Engine</a>，和 Google Chrome 一樣</p>
<p>V8 Engine 預設給 heap size 的大小限制是</p>
<ul>
<li>32 bit 的平台為 0.7 GB</li>
<li>64 bit 的平台為 1.4 GB</li>
</ul>
<p>所以一但超過 V8 預設的記憶體限制，build 就會終止，為了是不要讓 NodeJS 使用太多系統的記憶體 (但 Chrome 還是用得很兇欸..?)</p>
<h2 id="NodeJS-12"><a href="#NodeJS-12" class="headerlink" title="NodeJS 12"></a>NodeJS 12</h2><p>好消息是在 <a href="https://medium.com/@nodejs/introducing-node-js-12-76c41a1b3f3f" target="_blank" rel="noopener">NodeJS 12 的 intro</a> 中有提到，已經拿掉預設的 heap limits，改成是 config 目前可用的 memory</p>
<blockquote>
<p>This update will configure the JavaScript heap size based on available memory instead of using defaults that were set by V8 for use with browsers. In previous releases, unless configured, V8 defaulted to limiting the max heap size to 700 MB or 1400MB on 32 and 64-bit platforms respectively. Configuring the heap size based on available memory ensures that Node.js does not try to use more memory than is available and terminating when its memory is exhausted.</p>
</blockquote>
<blockquote>
<p>This is particularly useful when processing large data-sets. As before, it will still be possible to set — max-old-space-size to use a different limit if the default is not appropriate for your application.</p>
</blockquote>
<p>在這個 <a href="https://github.com/angular/angular-cli/issues/12645" target="_blank" rel="noopener">Angular Github thread</a> 中也有提到這件事，說升級到 Node 12 就解決</p>
<p>但底下有個人說使用 Node 12 還是有一樣的問題，這可能就要再深入看看為什麼，不過目前專案改成使用 Node 12+ 的版本後，我在 RAM 很小的 Windows VM 上跑 Jenkins 沒再遇過 Heap out of memory 了</p>
<h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>做個簡單紀錄，真正的原因我還是不能確定是什麼XD，一開始先用了 max size 安然跑了兩個月，後來在測試一些情況時不小心把 max size 移掉後才發現沒有這問題了，而最近才讀到原來 Node 12+ 有改善這件事，所以才想到也許是跟專案前個月開始升成使用 Node 12+ 有關，回頭審視了下當初的問題</p>
<p>有關於 OS &amp; memory 的坑真的很深，或許日後有更多這方面的經驗跟心得再說說(<del>通常這麼說就是不會有</del>)</p>

        </div>

        
            <section class="post-copyright">
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span class="permalink-text"><a href="http://havincy.github.io/post/NodeHeapOutOfMemory/">http://havincy.github.io/post/NodeHeapOutOfMemory/</a></span>
                    </p>
                
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Stay Foolish, Stay Hungry</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Angular/">#Angular</a>
                    
                        <a href="/tags/NodeJS/">#NodeJS</a>
                    
                        <a href="/tags/npm/">#npm</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/post/2019-NewZealand-Travel-Airport-Notes/">2019 紐西蘭自助-奧克蘭轉機出入境</a>
            
            
            <a class="next" rel="next" href="/post/SchwabUpgradeNotes/">Schwab 嘉信理財-帳戶申請升級心得</a>
            
        </section>
        <div>
        
            <section id="comments">
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
              </div>
            </section>
        
        </div>
    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>haVincy © Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

        
    <script>
      var disqus_shortname = 'havincy-github-io';
      
      var disqus_url = 'http://havincy.github.io/post/NodeHeapOutOfMemory/';
      
      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    
    

    </div>
</body>
</html>
