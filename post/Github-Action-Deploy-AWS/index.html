<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="NEW NUY">





<title>ç”¨ Github Actions éƒ¨ç½² AWS EC2 &amp; S3 | NEWNUY&#39;s Reflection</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<!-- Global site tag (gtag.js) - Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162520708-1"></script>
    <script>
        var host = window.location.hostname;
        // Avoid 'localhost' to be tracked
        if (host !== "localhost") {
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-162520708-1');
        }
    </script>


<!-- Google AdSense script -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7455155284654484"
crossorigin="anonymous"></script>

<meta name="generator" content="Hexo 4.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Memento mori</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about/">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Memento mori</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about/">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ç”¨ Github Actions éƒ¨ç½² AWS EC2 &amp; S3</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: June 20, 2021
                    
                    
                        </span>
                    
                        <div>
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/DevOps/">DevOps</a>
                            
                        </span>
                        </div>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è£œå®Œä¸Šæ¬¡çš„ <a href="../Github-Actions-Intro/">Github Action ç³»åˆ—æ–‡</a></p>
<p>é€™ç¯‡æœƒç°¡å–®æ•˜è¿°å¦‚ä½•è®“ Github Actions æ­é… AWS çš„æœå‹™åšå‰å¾Œç«¯çš„éƒ¨ç½²(CD - Continuous Deployment)ï¼Œè®“ AWS Live URL çš„ç‹€æ…‹è·Ÿ Repo ä¿æŒä¸€è‡´</p>
<p>æˆ‘å€‘æ˜¯åˆ©ç”¨ <a href="https://aws.amazon.com/ec2/?ec2-whats-new.sort-by=item.additionalFields.postDateTime&amp;ec2-whats-new.sort-order=desc" target="_blank" rel="noopener">AWS EC2 web service</a> åœ¨å…¬é–‹ç¶²è·¯ä¸ŠåŸ·è¡Œç¶²é æœå‹™ä¾† run side project</p>
<p>æ­¤ç¯‡æ˜¯å‡è¨­ä½ å·²ç¶“æœ‰äº† AWS EC2 çš„çŸ¥è­˜çš„å‰æä¸‹ï¼Œè©²å¦‚ä½•åˆ©ç”¨ Github Action ä¾†ä¸²æœ€å¾Œçš„ Deploy</p>
<p>å°å¦‚ä½•ä½¿ç”¨ AWS EC2 æœ‰èˆˆè¶£çš„äººå¯ä»¥åƒè€ƒå…è²»çš„å®˜æ–¹æ–‡ä»¶æˆ–æ˜¯å„é¡ç·šä¸Šæ•™å­¸</p>
<h2 id="AWS-CodeDeploy"><a href="#AWS-CodeDeploy" class="headerlink" title="AWS CodeDeploy"></a>AWS CodeDeploy</h2><p>åˆ©ç”¨ AWS ç¾æˆçš„æœå‹™ CodeDeploy å°±èƒ½è·Ÿ Github Actions å®Œæˆè‡ªå‹•éƒ¨ç½²çš„è…³æœ¬</p>
<p>AWS è‡ªå·±æœ‰åœ¨ Github Actions Market å‡ºäº†å®˜æ–¹å¥—ä»¶çµ¦é–‹ç™¼è€…æ•´åˆ AWS Keyï¼Œä¹Ÿæœ‰ç›¸é—œçš„èªªæ˜æ–‡ä»¶</p>
<ul>
<li><a href="https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions" target="_blank" rel="noopener">https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions</a></li>
<li><a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/integrations-partners-github.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/codedeploy/latest/userguide/integrations-partners-github.html</a></li>
</ul>
<h3 id="AWS-IAM-Role"><a href="#AWS-IAM-Role" class="headerlink" title="AWS IAM Role"></a>AWS IAM Role</h3><p>é¦–å…ˆå¾—åœ¨ IAM æœå‹™å…§æ–°å¢ä¸€å€‹ IAM rule çµ¦è¦æ­é… Github Action éƒ¨ç½²ç”¨çš„ CodeDeploy ä½¿ç”¨å»ç”¢ç”Ÿå°æ‡‰çš„ Access Key Pair</p>
<p>IAM -&gt; Access management -&gt; Users </p>
<p>æ–°å¢ä¸€å€‹ User å–åå« CodeDeployï¼ŒPolicy åŠ å…¥ AWS å·²ç¶“æ‰“åŒ…å¥½ policy package</p>
<p>Add Inline policy -&gt; Import managed policy</p>
<img src="/post/Github-Action-Deploy-AWS/AWS-Import-Managed-Policy.png" class="">

<p>æœå°‹ â€œAWSCodeDeployâ€ å°±æœƒå‡ºç¾ä¸€äº›å·²ç¶“æ‰“åŒ…å¥½çš„ policy é›†åˆï¼Œé¸æ“‡ â€œAWSCodeDeployDeployerAccessâ€</p>
<img src="/post/Github-Action-Deploy-AWS/AWS-Import-CodeDeploy-Policy.png" class="">

<p>åœ¨å»ºç«‹å¥½çš„ IAM User é¸å–®å…§é¸æ“‡ Security credentials -&gt; Create access key å°±æœƒå¾—åˆ°ä¸€çµ„ Access keyï¼Œé€™æœƒéœ€è¦æ”¾åœ¨åœ¨ Github repo ä¸­çš„ Secrets å…§ä¾› Actions è…³æœ¬å–ç”¨ï¼Œå»ºè­°å…ˆè¤‡è£½åˆ°è¨˜äº‹æœ¬æ–¹ä¾¿ç­‰ç­‰è²¼ä¸Š</p>
<p>Note: Secret Key å‹™å¿…è‡ªå·±ç´€éŒ„å¥½ï¼Œä¸€ä½†å»ºç«‹å®Œç•¢ï¼Œå°±ç„¡æ³•å†çœ‹åˆ°ï¼Œ<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html?icmpid=docs_iam_console" target="_blank" rel="noopener">AWS å®˜æ–¹å»ºè­°</a>ç®¡ç†å“¡æ™‚ä¸æ™‚å°±æ‡‰è©²æ›æ–°çš„ Access Key ä¾†ç¢ºä¿ç³»çµ±å®‰å…¨</p>
<blockquote>
<p>For your protection, you should never share your secret keys with anyone. As a best practice, we recommend frequent key rotation. If you lose or forget your secret key, you cannot retrieve it. Instead, create a new access key and make the old key inactive.</p>
</blockquote>
<h2 id="Github-Secrets"><a href="#Github-Secrets" class="headerlink" title="Github Secrets"></a>Github Secrets</h2><p>åˆ°éœ€è¦åš CD çš„ Github Repo ä¸­çš„ Settings -&gt; Secrets å…§å»ºç«‹æ–°çš„ Secrets</p>
<p>æŠŠå‰›å‰›å»ºç«‹å¥½çš„ CodeDeploy User çš„</p>
<ul>
<li>AWS Access Secret Key æ”¾åˆ° Value æ¬„ä½å…§ï¼Œå–åç‚º <code>AWS_SECRET_ACCESS_KEY</code></li>
<li>AWS Access Key ID æ”¾åˆ° Value æ¬„ä½å…§ï¼Œå–åç‚º <code>AWS_ACCESS_KEY_ID</code></li>
</ul>
<img src="/post/Github-Action-Deploy-AWS/Github-Add-Secrets.png" class="">

<h2 id="CD-pipeline"><a href="#CD-pipeline" class="headerlink" title="CD pipeline"></a>CD pipeline</h2><p>å‰ç½®æº–å‚™éƒ½å·®ä¸å¤šäº†ï¼Œå°±åŠ å…¥ä»¥ä¸‹çš„ yml æª”æ¡ˆ</p>
<p><a href="https://docs.github.com/en/actions/reference/events-that-trigger-workflows#workflow_dispatch" target="_blank" rel="noopener">workflow_dispatch</a> æ˜¯ Github Actions æ”¯æ´æ‰‹å‹• trigger çš„èªæ³•</p>
<h3 id="deploy-yml-example"><a href="#deploy-yml-example" class="headerlink" title="deploy.yml example"></a>deploy.yml example</h3><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">commitId:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">'git commit Id to deploy'</span>     </span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deployBackend:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">CD</span> <span class="bullet">-</span> <span class="string">AWS</span> <span class="string">codedeploy</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">appname:</span> <span class="string">['Your_Web_Service_Folder']</span></span><br><span class="line">        <span class="attr">deploy-group:</span> <span class="string">['Your_Deployment_Group_Name']</span></span><br><span class="line">        <span class="attr">repository:</span> <span class="string">['Your_Github_Repo']</span></span><br><span class="line">        <span class="attr">aws-region:</span> <span class="string">['us-east-1']</span></span><br><span class="line">        </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">aws-access-key-id:</span> <span class="string">${{</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">aws-secret-access-key:</span> <span class="string">${{</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">${{</span> <span class="string">matrix.aws-region</span> <span class="string">}}</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CommitId</span> <span class="string">to</span> <span class="string">be</span> <span class="string">deployed</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"Deploying code commit: $<span class="template-variable">{{ github.event.inputs.commitId }}</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AWS</span> <span class="string">Create</span> <span class="string">Deployment</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">aws</span> <span class="string">deploy</span> <span class="string">create-deployment</span> <span class="string">\</span></span><br><span class="line">          <span class="string">--application-name</span> <span class="string">${{</span> <span class="string">matrix.appname</span> <span class="string">}}</span> <span class="string">\</span></span><br><span class="line">          <span class="string">--deployment-config-name</span> <span class="string">CodeDeployDefault.OneAtATime</span> <span class="string">\</span></span><br><span class="line">          <span class="string">--deployment-group-name</span> <span class="string">${{</span> <span class="string">matrix.deploy-group</span> <span class="string">}}</span> <span class="string">\</span></span><br><span class="line">              <span class="string">--file-exists-behavior</span> <span class="string">OVERWRITE</span> <span class="string">\</span></span><br><span class="line">              <span class="string">--github-location</span> <span class="string">repository=${{</span> <span class="string">matrix.repository</span> <span class="string">}},commitId=${{</span> <span class="string">github.event.inputs.commitId</span> <span class="string">}}</span></span><br></pre></td></tr></tbody></table></figure>

<p>æ‰‹å‹•åŸ·è¡Œé€™å€‹ workflow å°±æœƒæŠŠç›®å‰çš„ Github Repo Deploy åˆ°ä½ çš„ EC2 ä¸Šï¼Œåœ¨ CodeDeploy service ä¸­çš„ Deployments å°±èƒ½çœ‹åˆ°æ­·å²ç´€éŒ„ï¼Œä»¥åŠæ¯ç­† Deploy çš„ç‹€æ…‹</p>
<img src="/post/Github-Action-Deploy-AWS/AW-CodeDeployment-History.png" class="">

<h3 id="appspec-yml"><a href="#appspec-yml" class="headerlink" title="appspec.yml"></a>appspec.yml</h3><p>é€™æ˜¯ <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html" target="_blank" rel="noopener">AWS CodeDeploy çš„æè¿°æª”</a></p>
<p>æ˜¯æŒ‡å®š source (ç›®å‰ repo ä¸­çš„æª”æ¡ˆ) èˆ‡ destination (åœ¨ EC2 ä¸Šè¦æ”¾çš„ä½ç½®) çš„é‡è¦æª”æ¡ˆ</p>
<p>ä¹Ÿæ˜¯åœ¨ Deployed åˆ° EC2 å¾Œï¼Œèƒ½é‹ç”¨ Life cycle Hook åŸ·è¡Œä¸åŒ script çš„æª”æ¡ˆ</p>
<p>æ¯”å¦‚æˆ‘å€‘éœ€è¦åœæ­¢ç›®å‰çš„ web serviceï¼Œé‡æ–° launchï¼Œæˆ–æ˜¯é‡æ–° build sources</p>
<ul>
<li>BeforeInstall</li>
<li>AfterInstall</li>
<li>ApplicationStart</li>
<li>ApplicationStop</li>
</ul>
<p>æˆ‘å€‘åœ¨ appsepc æª”åŠ çš„ hook é‚è¼¯ç®—æ˜¯æ¯”è¼ƒç°¡ç•¥çš„ï¼Œç•¢ç«Ÿä¸æ˜¯å¤ªå¤§çš„æ‡‰ç”¨ï¼Œæ˜¯é–’æš‡æ™‚åšèˆˆè¶£çš„ side project ğŸ˜¬</p>
<p>æ”¾åœ¨ aws-scripts å…§çš„ .sh å°±æ˜¯ä¾› AWS CodeDeploy åœ¨ä¸åŒ Life Cycle åŸ·è¡Œç”¨çš„</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.0</span></span><br><span class="line"><span class="attr">os:</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">destination:</span> <span class="string">Your_Destination_Folder_on_EC2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Life cycle hooks once deployment is executed to EC2 instance</span></span><br><span class="line"><span class="attr">hooks:</span></span><br><span class="line">  <span class="attr">AfterInstall:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">location:</span> <span class="string">aws-scripts/after_install.sh</span></span><br><span class="line">      <span class="attr">runas:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">ApplicationStart:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">location:</span> <span class="string">aws-scripts/docker_up.sh</span></span><br><span class="line">      <span class="attr">runas:</span> <span class="string">root</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Frontend-CD"><a href="#Frontend-CD" class="headerlink" title="Frontend CD"></a>Frontend CD</h2><p>å‰ç«¯çš„ CD ç¨ç«‹å‡ºä¾†ç´€éŒ„æ˜¯å› ç‚ºé€™åŒ… Side project æ˜¯å‰å¾Œç«¯æ”¾åœ¨ä¸€èµ·ï¼Œé¿å…æª”æ¡ˆè¤‡é›œåº¦ï¼Œæ‰€ä»¥åªæ”¾ codesï¼Œä¸¦ä¸æœƒæ”¾ frontend build å®Œå¾Œçš„ web sources</p>
<p>æ›å¥è©±èªªï¼Œæˆ‘å€‘éœ€è¦æœ‰å€‹æ©Ÿåˆ¶å¯ä»¥è®“ Github Actions æ­é… AWS èƒ½ Build + Deploy å‰ç«¯</p>
<p>åœ¨æˆ‘å€‘çš„ Case ä¸­ï¼Œå› ç‚ºæ˜¯ä½¿ç”¨å…è²»çš„ AWSï¼Œåœ¨å„é¡è³‡æºä¸è¶…éé™åˆ¶ç”¨é‡çš„è€ƒé‡ä¸‹ï¼Œæˆ‘é¸æ“‡å°‡å‰ç«¯ç¨ç«‹æ‹†é–‹ä¾†åš CD preparation</p>
<h3 id="S3-bucket"><a href="#S3-bucket" class="headerlink" title="S3 bucket"></a>S3 bucket</h3><p>å˜—è©¦äº†ä¸€äº›æ–¹æ³•å¾Œï¼Œ<strong>æˆ‘çš„æ–¹å¼å°±æ˜¯å°‡ frontend build ä¸Šå‚³åˆ° S3 bucketï¼Œåœ¨ CodeDeploy AfterInstall ä¸­æŠŠ S3 bucket çš„æ±è¥¿ sync åˆ° EC2 æŒ‡å®šçš„ä½ç½®ï¼Œæœ€å¾Œå†é‡æ–° Launch web service</strong></p>
<img src="/post/Github-Action-Deploy-AWS/AWS-S3-Create.png" class="">

<p>åŸºæœ¬ä¸Šä¸éœ€è¦æ”¹é è¨­çš„é¸é …ï¼Œä¸€è·¯ä¸‹ä¸€æ­¥ä¸‹å»å°±å¯ä»¥ï¼Œ<strong>å­˜å–çš„æ–¹å¼ä¸€æ¨£é€é AWS Access Keyï¼Œä¸éœ€è¦ç‰¹åˆ¥è¨­ç½®æˆ Public bucket</strong></p>
<p>å»ºç«‹å¥½è¦å­˜æ”¾è³‡æºçš„ S3 bucket å¾Œï¼Œå°±åˆ° IAM service ä¸­ CodeDeploy Userï¼Œ<strong>Import å¦ä¸€å€‹æ‰“åŒ…å¥½çš„ Policy â€œAmazonS3FullAccessâ€</strong>ï¼Œæˆ‘é¸æ“‡ç”¨åŒä¸€æŠŠ AWS Access Key ä¾†åŸ·è¡Œä¸Šå‚³åˆ° S3 çš„ Github Actions workflow</p>
<p>é€™è£¡è¨­ç½®æˆæ‰‹å‹•åŸ·è¡Œï¼Œå› ç‚ºå…è²»çš„ AWS å¸³è™Ÿæœ‰é™åˆ¶ S3 æ¯æœˆçš„ä¸Šå‚³æ¬¡æ•¸XDï¼Œä¸å¸Œæœ›æ˜¯æ¯æ¨ä¸€æ¬¡ commit å°±è·‘ä¸€æ¬¡ï¼Œè…³æœ¬å…§é¸æ“‡å°‡ frontend build å…ˆæ‰“åŒ…æˆ zip å†ä¸Šå‚³åˆ° S3 ä¹Ÿæ˜¯ä¸€æ¨£çš„åŸå› â€¦å› ç‚ºå‚³ä¸€å€‹æª”æ¡ˆå°±ç®—ä¸€æ¬¡å”· ğŸ˜‚</p>
<h3 id="upload-yml-example"><a href="#upload-yml-example" class="headerlink" title="upload.yml example"></a>upload.yml example</h3><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Upload</span> <span class="string">Frontend</span> <span class="string">to</span> <span class="string">S3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">'tag - please input date MM/DD/YYYY'</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deployFrontend:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Upload</span> <span class="bullet">-</span> <span class="string">Frontend</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">node-version:</span> <span class="string">['13.14.x']</span></span><br><span class="line">        <span class="attr">aws-region:</span> <span class="string">['us-east-1']</span></span><br><span class="line">        <span class="attr">s3-bucket:</span> <span class="string">['Your_S3_Bucket_Name']</span></span><br><span class="line">        <span class="attr">web-source:</span> <span class="string">['out.zip']</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># Checks out a copy of your repository on the ubuntu-latest machine</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Set up required dev env</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Node.js</span> <span class="string">${{</span> <span class="string">matrix.node-version</span> <span class="string">}}</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">${{</span> <span class="string">matrix.node-version</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Building</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">working-directory:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"Tag: $<span class="template-variable">{{ github.event.inputs.tags }}</span>"</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">install</span> <span class="string">--save-exact</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Building</span> <span class="string">Frontend</span></span><br><span class="line">        <span class="attr">working-directory:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">          <span class="string">zip</span> <span class="string">-r</span> <span class="string">${{</span> <span class="string">matrix.web-source</span> <span class="string">}}</span> <span class="string">your_web_build_folder</span></span><br><span class="line">          <span class="string">ls</span> <span class="string">${{</span> <span class="string">matrix.web-source</span> <span class="string">}}</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">aws-access-key-id:</span> <span class="string">${{</span> <span class="string">secrets.AWS_ACCESS_KEY_ID</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">aws-secret-access-key:</span> <span class="string">${{</span> <span class="string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">${{</span> <span class="string">matrix.aws-region</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Uploading</span> <span class="string">to</span> <span class="string">S3</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">aws</span> <span class="string">s3</span> <span class="string">cp</span> <span class="string">frontend/${{</span> <span class="string">matrix.web-source</span> <span class="string">}}</span> <span class="string">s3://${{</span> <span class="string">matrix.s3-bucket</span> <span class="string">}}/frontend/</span> <span class="string">--acl</span> <span class="string">bucket-owner-full-control</span></span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://docs.aws.amazon.com/cli/latest/reference/s3/" target="_blank" rel="noopener">AWS S3 æŒ‡ä»¤å¯ä»¥ç›´æ¥åƒè€ƒå®˜æ–¹æ–‡ä»¶</a>ï¼Œä¾†çœ‹ä½ éœ€è¦æ€éº¼æ¨£çš„æŒ‡ä»¤ï¼Œæˆ‘æ˜¯ç”¨ <code>aws s3 cp</code> ä¾†ä¸Šå‚³</p>
<h3 id="AfterInstall-hook"><a href="#AfterInstall-hook" class="headerlink" title="AfterInstall hook"></a>AfterInstall hook</h3><p>åŸ·è¡Œå®Œä¸Šå‚³ frontend build åˆ° S3 bucket å¾Œï¼Œæˆ‘å€‘åœ¨ CodeDeploy å®Œæˆå¾Œçš„ç¬¬ä¸€æ­¥è¦åšçš„äº‹å°±æ˜¯æŠŠ frontend build å¾ S3 bucket æŠ“ä¸‹ä¾†ï¼Œæ‰æœ‰è¾¦æ³•é‡æ–°åŸ·è¡Œ web service å»åæ‡‰æœ€æ–°çš„ç‹€æ…‹</p>
<p>æƒ³æ³•å…¶å¯¦ç›´è¦ºçš„ï¼Œä¸éå¯¦å‹™ä¸Šæ˜¯æ¸¬è©¦äº†å¥½å¹¾æ¬¡ï¼Œç¢ºå®šæœ‰ç…§é å®šçš„è·¯ç·šèµ°ä¸‹å»â€¦ğŸ˜…</p>
<p><strong>after_install.sh example</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"[AfterInstall] downloading frontend sources from S3"</span></span><br><span class="line">aws s3 cp s3://Your_S3_Bucket_Name/Your_zip_file /Target_folder_on_EC2/</span><br><span class="line">unzip -o /Target_folder_on_EC2/Your_zip_file -d /Target_folder_on_EC2/</span><br></pre></td></tr></tbody></table></figure>

<p>æ‰€ä»¥ CodeDeploy ä¸æ­¢å¯ä»¥æ­é… EC2ï¼Œæœ‰ hook çš„å¹«åŠ©ï¼ŒæŒ‡ä»¤èƒ½åšçš„äº‹æƒ…åŸºæœ¬ä¸Šéƒ½èƒ½å¤ åšåˆ°ï¼Œ<strong>è¦æ³¨æ„çš„å°±æ˜¯ AWS IAM æ¬Šé™</strong>ï¼Œç•¶åˆå› ç‚ºä¸ç†Ÿä¸€ç›´ç¢°å£ï¼Œè¦å¤šç©å€‹å¹¾æ¬¡æ‰æ¯”è¼ƒæœ‰æ„Ÿè¦º</p>
<h3 id="ApplicationStart-hook"><a href="#ApplicationStart-hook" class="headerlink" title="ApplicationStart hook"></a>ApplicationStart hook</h3><p>é€™é‚Šæˆ‘å€‘åšçš„äº‹æƒ…å°±æ˜¯åˆ° destination folder æŠŠå‰å¾Œç«¯éƒ½é‡æ–° build ä¸€æ¬¡ï¼Œç„¶å¾Œè®“æ•´å€‹ web service launch èµ·ä¾†</p>
<p>Note: hook åŸ·è¡Œçš„ä½ç½®åœ¨ EC2 root åº•ä¸‹ï¼Œè·Ÿ <code>appspec.yml</code> ä¸­å®šç¾©çš„ destination ä¸€æ¨£</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Your_Destination_Folder_on_EC2 </span><br><span class="line"><span class="comment">## Execute your building process and launch the application</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h2><p>é€™é‚Šå°±ä¸ç‰¹åˆ¥è«‡ Docker çš„éƒ¨åˆ†ï¼Œå› ç‚ºæ˜¯è² è²¬å¾Œç«¯çš„æœ‹å‹æŠŠ Docker build å¼•å…¥ side project çš„ï¼Œæ‡‰è©²å¾ˆå¤š web service ä¸ä¸€å®šéœ€è¦è·‘ Docker build</p>
<p>ç¸½è€Œè¨€ä¹‹å°±æ˜¯æŠŠéœ€è¦å•Ÿå‹•ç¶²é æ‡‰ç”¨çš„æ­¥é©Ÿè®Šæˆåœ¨ AWS service ä¸Šä¾†åŸ·è¡Œï¼Œä¸¦é€é Github Actions çš„è…³æœ¬ä¾†å¹«æˆ‘å€‘ä¸€éµåˆ°ä½ ğŸ¤Ÿ</p>

        </div>

        
            <section class="post-copyright">
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span class="permalink-text"><a href="http://havincy.github.io/post/Github-Action-Deploy-AWS/">http://havincy.github.io/post/Github-Action-Deploy-AWS/</a></span>
                    </p>
                
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Stay Foolish, Stay Hungry</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/GithubActions/">#GithubActions</a>
                    
                        <a href="/tags/AWS/">#AWS</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/post/iOS-Safari-14-6-IndexedDB-Bug/">æ€éº¼è§£æ±º iOS 14.6 IndexedDB Hanging Bug</a>
            
            
            <a class="next" rel="next" href="/post/Wisdom-Teeth-Extraction-Review/">ä¸€æ¬¡æ‹”é™¤ä¸‰é¡†æ™ºé½’çš„å¿ƒå¾—</a>
            
        </section>
        <div>
        
            <section id="comments">
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
              </div>
            </section>
        
        </div>
    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>haVincy Â© Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

        
    <script>
      var disqus_shortname = 'havincy-github-io';
      
      var disqus_url = 'http://havincy.github.io/post/Github-Action-Deploy-AWS/';
      
      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    
    

    </div>
</body>
</html>
